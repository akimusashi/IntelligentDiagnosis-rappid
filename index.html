<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>IntelligentDiagnosis</title>
    <link rel="stylesheet" type="text/css" href="build/rappid/rappid.css">

    <style type="text/css">
        #container {
            height: 602px;
            padding: 0;
            margin: 0;
            border: 1px solid #0070ff;
            position: relative;
        }

        #paper {
            width: 800px;
            height: 600px;
            padding: 0;
            margin: 0;
            border: 1px solid #0070ff;
            display: inline-block;
            position: absolute;
            left: 201px;
        }

        #stencil {
            width: 200px;
            height: 300px;
            padding: 0;
            margin: 0;
            border: 1px solid #0070ff;
            display: inline-block;
            position: absolute;
            top: 0;
        }

        #navigator {
            width: 200px;
            height: 299px;
            padding: 0;
            margin: 0;
            border: 1px solid #0070ff;
            display: inline-block;
            position: absolute;
            top: 301px;
        }

        /*辅助线样式*/
        #paper .snapline.horizontal {
            border-bottom: 1px solid #ff9300;
            /*box-shadow: 0 0 1px #404040;*/
        }

        #paper .snapline.vertical {
            border-right: 1px solid #0088ff;
            /*box-shadow: 0 0 1px #404040;*/
        }

        .controller {
            margin: 6px;
        }

        .form-box {
            width: 180px;
        }
    </style>
</head>
<body>
<div class="controller">
    <input class="form-box" id="modelName" title="model name"/>
    <button type="button" id="saveGraph">SaveGraph</button>
    <select class="form-box" id="selectGraph" title="select model"></select>
    <button type="button" id="updateGraph">UpdateGraph</button>
    <button type="button" id="clearGraph">ClearGraph</button>
</div>
<div id="container">
    <div id="stencil"></div>
    <div id="paper"></div>
    <div id="navigator"></div>
</div>

<script type="text/javascript" src="build/jquery/jquery.js"></script>
<script type="text/javascript" src="build/lodash/lodash.js"></script>
<script type="text/javascript" src="build/backbone/backbone.js"></script>

<script type="text/javascript" src="build/rappid/rappid.js"></script>

<script type="text/javascript">
    var _paper = $('#paper');
    var _stencil = $('#stencil');
    var _navigator = $('#navigator');

    //画布
    var graph = new joint.dia.Graph;
    var paper = new joint.dia.Paper({
        /*el: _paper,*/
        width: 800,
        height: 600,
        gridSize: 8,
        drawGrid: {
            name: 'doubleMesh',
            args: [
                {color: '#dcdcdc', thickness: 1},
                {color: '#a0a0a0', scaleFactor: 10, thickness: 1}
            ]
        },
        model: graph,
        defaultLink: new joint.dia.Link({
            attrs: {
                '.connection': {stroke: 'blue'},
                '.marker-source': {fill: 'yellow', d: 'M 2 5 A 4 4 0 0 0 10 5 A 4 4 0 0 0 2 5'},
                '.marker-target': {fill: 'red', d: 'M 10 1 L 0 5 L 10 9 z'}
            }
        }),
        defaultRouter: {
            name: 'manhattan'
        }
    });

    //工具板
    var stencil = new joint.ui.Stencil({
        graph: graph,
        paper: paper,
        width: 200,
        height: 200,
        groups: {
            simple: {
                label: 'simple',
                index: 1,
                closed: false
            },
            other: {
                label: 'other',
                index: 2,
                closed: true
            }
        },
        search: {
            '*': ['attrs/text/text', 'description']
        }
    });
    _stencil.append(stencil.render().el);

    //工具板内容
    var r = new joint.shapes.basic.Rect({
        position: {
            x: 10,
            y: 10
        },
        size: {
            width: 70,
            height: 40
        },
        attrs: {
            rect: {
                fill: '#d6ffc8',
                stroke: '#6dff00',
                'stroke-width': 4
            },
            text: {
                text: 'rect',
                fill: '#757575'
            }
        },
        description: '矩形'
    });
    var c = new joint.shapes.basic.Circle({
        position: {
            x: 100,
            y: 10
        },
        size: {
            width: 70,
            height: 40
        },
        attrs: {
            circle: {
                fill: '#ffb8c9',
                stroke: '#ff0061',
                'stroke-width': 4
            },
            text: {
                text: 'ellipse',
                fill: '#757575'
            }
        },
        description: '圆'
    });
    var triangle = new joint.shapes.basic.Path({
        position: {
            x: 100,
            y: 10
        },
        size: {
            width: 70,
            height: 60
        },
        attrs: {
            path: {
                d: 'M 0 0 L 100 0 50 87 z',
                fill: '#aaff51',
                stroke: '#ff0061',
                'stroke-width': 4
            },
            text: {
                text: 'triangle',
                fill: '#757575',
                'y-alignment': 'middle',
                "ref-y": .2,
                "ref-dy": null
            }
        },
        description: '多边形'
    });
    var t = new joint.shapes.basic.Text({
        position: {
            x: 10,
            y: 10
        },
        size: {
            width: 50,
            height: 30
        },
        attrs: {
            text: {
                text: 'Text',
                'font-weight': 'bold'
            }
        },
        description: '文字'
    });
    stencil.load([r, c], 'simple');
    stencil.load([triangle], 'other');
    stencil.on('filter', function (graph, group) {
        console.log(graph, group);
    });

    //辅助线
    var snaplines = new joint.ui.Snaplines({
        paper: paper
    });
    snaplines.startListening();

    //选中监听
    paper.on('cell:pointerup', function (cellView, evt) {
        if (cellView.model instanceof joint.dia.Link) return;

        var data = cellView.model.attributes.data;
        if (data) {
            data = JSON.stringify(data).replace(/,["']/g, ' ').replace(/["']:/g, ': ').replace(/{["']|}/g, '');
        }

        if (!(evt.ctrlKey || evt.metaKey)) {
            var halo = new joint.ui.Halo({
                cellView: cellView,
                boxContent: data
            });
            halo.removeHandle('rotate').removeHandle('clone').removeHandle('fork');
            halo.changeHandle('unlink', {position: 'sw'});
            halo.changeHandle('link', {position: 'ne'});
            halo.render();
        }
    });

    //元素选择
    var selection = new joint.ui.SelectionView({paper: paper});
    //拉框选择
    paper.on('blank:pointerdown', selection.startSelecting);
    //点选
    paper.on('element:pointerup', function (elementView, evt) {
        if (evt.ctrlKey || evt.metaKey) {
            selection.collection.add(elementView.model);
        }
    });
    selection.on('selection-box:pointerdown', function (elementView, evt) {
        if (evt.ctrlKey || evt.metaKey) {
            selection.collection.remove(elementView.model);
        }
    });

    //画布滚动条
    var paperScroller = new joint.ui.PaperScroller({
        autoResizePaper: true,
        padding: 60,
        paper: paper
    });
    //拖动画布
    /*paper.on('blank:pointerdown', paperScroller.startPanning);*/
    //画框大小
    paperScroller.$el.css({
        width: 800,
        height: 600
    });
    //加入画框
    _paper.append(paperScroller.render().el);
    paperScroller.center();

    //导航
    var nav = new joint.ui.Navigator({
        paperScroller: paperScroller,
        width: 198,
        height: 299,
        padding: 6,
        zoomOptions: {max: 2, min: 0.2}
    });
    _navigator.append(nav.render().el);

    graph.on('add', function (cell) {
        cell.attributes.data = {
            apple: 1,
            banana: 2,
            cat: 3,
            dog: 4
        };
    });

    (function () {
        function appendOption(model_id, model_name) {
            $('#selectGraph').append('<option value="' + model_id + '">' + model_name + '</option>');
        }

        if (window.WebSocket) {
            var ws = new WebSocket('ws://127.0.0.1:8080');
            var modelName;
            ws.onopen = function () {
                console.log('连接服务器成功');
                $('#saveGraph').click(function () {
                    modelName = $.trim($('#modelName').val());
                    if (modelName !== '') {
                        var graphString = JSON.stringify(graph);
                        var params = 'add&$&' + modelName + '&$&' + graphString;
                        ws.send(params);
                    } else {
                        alert('Please enter your model name!');
                    }
                });

                ws.send('search');

                $('#selectGraph').change(function () {
                    var modelId = $(this).val();
                    if (modelId !== '0') {
                        var params = 'selectById&$&' + modelId;
                        ws.send(params);
                    }
                });

                $('#updateGraph').click(function () {
                    var modelId = $('#selectGraph').val();
                    if (modelId !== '0') {
                        var graphString = JSON.stringify(graph);
                        var params = 'update&$&' + modelId + '&$&' + graphString;
                        ws.send(params);
                    } else {
                        alert('Please select a model!');
                    }
                });

                $('#clearGraph').click(function () {
                    graph.clear();
                });
            };
            ws.onclose = function () {
                console.log('服务器关闭');
            };
            ws.onerror = function () {
                console.log('连接出错');
            };
            ws.onmessage = function (msg) {
                console.log('获取服务器信息');

                msg = JSON.parse(msg.data);

                if (msg.type === 'model_list') {
                    var array = msg.data;
                    appendOption(0, 'select model');
                    for (var i = 0, len = array.length; i < len; i++) {
                        appendOption(array[i].id, array[i].model_name);
                    }
                } else if (msg.type === 'model_id') {
                    var model_graph = msg.data[0].model_graph;
                    graph.fromJSON(JSON.parse(model_graph));
                } else if (msg.type === 'model_add') {
                    if (msg.data.affectedRows === 1) {
                        appendOption(msg.data.insertId, modelName);
                    }
                }
            }
        }
    })();
</script>
</body>
</html>